---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "pubmed.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: pubmed.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">pydash</span> <span class="kn">import</span> <span class="n">get</span>
<span class="kn">from</span> <span class="nn">toolz</span> <span class="kn">import</span> <span class="n">thread_first</span>
<span class="kn">from</span> <span class="nn">typeguard</span> <span class="kn">import</span> <span class="n">typechecked</span>

<span class="kn">from</span> <span class="nn">proseflow.spec</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">proseflow.utils</span> <span class="kn">import</span> <span class="n">get_paths</span><span class="p">,</span> <span class="n">tree_select_kv</span>
<span class="kn">from</span> <span class="nn">Bio</span> <span class="kn">import</span> <span class="n">Entrez</span>
<span class="nd">@typechecked</span>
<span class="k">def</span> <span class="nf">_get_pubmed_records</span><span class="p">(</span>
    <span class="n">pmids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># -&gt; List[Tuple[str, str]]:</span>
    <span class="c1"># ! TODO: move this into auto convert</span>
<span class="c1">#     pmids_to_fetch = (</span>
<span class="c1">#         [pmid.split(&quot;/&quot;)[-2] for pmid in pmids]</span>
<span class="c1">#         if SPEC[PUBMED_IDS].match(pmids[0])</span>
<span class="c1">#         else pmids</span>
<span class="c1">#     )</span>
    <span class="n">Entrez</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;strasser.ms@gmail.com&quot;</span>

    <span class="c1"># handle type is http.client.HTTPResponse</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">Entrez</span><span class="o">.</span><span class="n">efetch</span><span class="p">(</span>
        <span class="n">db</span><span class="o">=</span><span class="s2">&quot;pubmed&quot;</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pmids</span><span class="p">)),</span>
        <span class="n">rettype</span><span class="o">=</span><span class="s2">&quot;xml&quot;</span><span class="p">,</span>
        <span class="n">retmode</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">Entrez</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">records</span>


<span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">keys_wanted</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">thread_first</span><span class="p">(</span>
        <span class="n">record</span><span class="p">,</span>
        <span class="c1"># (id_with_side, JSON),</span>
        <span class="n">get_paths</span><span class="p">,</span>
        <span class="nb">list</span><span class="p">,</span>
        <span class="c1"># print,</span>
        <span class="k">lambda</span> <span class="n">paths</span><span class="p">:</span> <span class="n">tree_select_kv</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">keys_wanted</span><span class="p">),</span>
        <span class="n">m_parse_flat_pubmed</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_pubmed_info</span><span class="p">(</span>
    <span class="n">pmids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">keys_wanted</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;PMID&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DateCompleted&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Journal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PubDate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AbstractText&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ChemicalList&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">):</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">_get_pubmed_records</span><span class="p">(</span><span class="n">pmids</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">get_info</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">keys_wanted</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">[</span><span class="s2">&quot;PubmedArticle&quot;</span><span class="p">]]</span>


<span class="k">def</span> <span class="nf">_get_pubmed_abstracts</span><span class="p">(</span><span class="n">pmids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;MedlineCitation.Article.Abstract.AbstractText&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">_get_pubmed_records</span><span class="p">(</span><span class="n">pmids</span><span class="p">)[</span><span class="s2">&quot;PubmedArticle&quot;</span><span class="p">]</span>
    <span class="p">]</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Achtung:</span>

<span class="sd">PubDate has form:</span>
<span class="sd">{</span>
<span class="sd">&quot;Year&quot;:&quot;1999&quot;,</span>
<span class="sd">&quot;Month&quot;:&quot;Nov&quot;, #stupid....</span>
<span class="sd">&quot;Day&quot;:&quot;09&quot;</span>
<span class="sd">}</span>
<span class="sd">and DateCompleted has form:</span>
<span class="sd">{</span>
<span class="sd">&quot;Year&quot;:&quot;1999&quot;,</span>
<span class="sd">&quot;Month&quot;:&quot;12&quot;,</span>
<span class="sd">&quot;Day&quot;:&quot;09&quot;</span>
<span class="sd">}</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">MONTH_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;JAN&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;FEB&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;MAR&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;APR&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;MAY&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;JUN&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s2">&quot;JUL&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;AUG&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s2">&quot;SEP&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;OCT&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;NOV&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
    <span class="s2">&quot;DEC&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">m_parse_flat_pubmed</span><span class="p">(</span><span class="n">flat_pm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;! make sure that all the key_wanted are represented here too ... otherwise key error&quot;&quot;&quot;</span>
    <span class="c1"># [{a:, b:}]</span>
    <span class="k">if</span> <span class="n">flat_pm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ChemicalList&quot;</span><span class="p">):</span>  <span class="c1"># only</span>
        <span class="c1"># stringelement</span>
        <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;ChemicalList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">chem</span><span class="p">[</span><span class="s2">&quot;NameOfSubstance&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">chem</span> <span class="ow">in</span> <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;ChemicalList&quot;</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="k">if</span> <span class="n">flat_pm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MeshHeadingList&quot;</span><span class="p">):</span>
        <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;MeshHeadingList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">mesh</span><span class="p">[</span><span class="s2">&quot;DescriptorName&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;MeshHeadingList&quot;</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="k">if</span> <span class="n">flat_pm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DateCompleted&quot;</span><span class="p">):</span>
        <span class="n">date_comp</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;DateCompleted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span>
        <span class="p">}</span>
        <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;DateCompleted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="o">**</span><span class="n">date_comp</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>

    <span class="c1"># TODO: not working with month --&gt; int(&quot;Nov&quot;) errror</span>
    <span class="c1"># date_pub = {key.lower(): int(num) for key, num in flat_pm[&quot;PubDate&quot;].items()}</span>
    <span class="c1"># date_pub[&quot;month&quot;] = MONTH_MAP[date_pub[&quot;month&quot;]] #Nov =&gt; 11</span>
    <span class="c1"># flat_pm[&quot;PubDate&quot;] = datetime(**date_pub).date()</span>

    <span class="c1"># {&quot;DAY&quot;:&quot;11&quot;} -&gt; {&quot;day&quot;: 11}</span>

    <span class="k">if</span> <span class="n">flat_pm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AbstractText&quot;</span><span class="p">):</span>
        <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;AbstractText&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;AbstractText&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">flat_pm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;JournalTitle&quot;</span><span class="p">):</span>
        <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;JournalTitle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;Journal&quot;</span><span class="p">][</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">flat_pm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PMID&quot;</span><span class="p">):</span>
        <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;PMID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;PMID&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">flat_pm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Journal&quot;</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">flat_pm</span><span class="p">[</span><span class="s2">&quot;Journal&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">flat_pm</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">JSON</span>
<span class="n">pm_record</span> <span class="o">=</span><span class="n">_get_pubmed_records</span><span class="p">([</span><span class="s2">&quot;28355534&quot;</span><span class="p">])</span> <span class="c1">#2019: 28355534 #1999: 10544064</span>
<span class="n">JSON</span><span class="p">(</span><span class="n">pm_record</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;IPython.core.display.JSON object&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

